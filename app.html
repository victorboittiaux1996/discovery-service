<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discovery Service - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 12px 20px; border-radius: 8px; font-weight: 500;
      opacity: 0; transform: translateY(10px); transition: all 0.3s;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.loading { background: #3b82f6; color: white; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="min-h-screen bg-zinc-950 text-white">

  <!-- Header -->
  <header class="border-b border-zinc-800 px-6 py-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Discovery Service</h1>
        <p class="text-zinc-500 text-sm">Admin - Gestion des prix</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/" target="_blank" class="text-zinc-400 hover:text-white text-sm transition">
          Voir le site →
        </a>
        <button onclick="copyLink()" class="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition">
          Copier le lien
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-6">

    <!-- Link Section -->
    <section class="mb-8 p-4 bg-zinc-900 border border-zinc-800 rounded-xl">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-zinc-500 text-sm mb-1">Lien public à partager</p>
          <p class="text-lg font-medium" id="public-link">https://discovery-service.vercel.app</p>
        </div>
        <button onclick="copyLink()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium transition">
          Copier
        </button>
      </div>
    </section>

    <!-- Font Selector -->
    <section class="mb-8">
      <h2 class="text-lg font-medium mb-4">Police du contenu</h2>
      <p class="text-zinc-500 text-sm mb-4">Le titre "DISCOVERY SERVICE" garde toujours Outfit</p>
      <div class="flex gap-3">
        <button onclick="selectFont('outfit')" id="font-outfit"
                class="flex-1 p-4 bg-zinc-900 border-2 border-blue-500 rounded-xl transition hover:border-blue-400">
          <p class="font-medium mb-1" style="font-family: 'Outfit', sans-serif;">Outfit</p>
          <p class="text-zinc-500 text-sm" style="font-family: 'Outfit', sans-serif;">Aa Bb Cc 123</p>
        </button>
        <button onclick="selectFont('system')" id="font-system"
                class="flex-1 p-4 bg-zinc-900 border-2 border-zinc-700 rounded-xl transition hover:border-zinc-500">
          <p class="font-medium mb-1" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">System</p>
          <p class="text-zinc-500 text-sm" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">Aa Bb Cc 123</p>
        </button>
      </div>
    </section>

    <!-- Pricing Editor -->
    <section class="space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium">Modifier les prix</h2>
        <button onclick="savePrices()" id="save-btn"
                class="bg-green-600 hover:bg-green-500 px-5 py-2 rounded-lg font-medium transition flex items-center gap-2">
          <span>Sauvegarder</span>
        </button>
      </div>

      <!-- Offer 01: Weekly Service -->
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
        <h3 class="text-zinc-400 text-sm uppercase tracking-wider mb-4">Offer 01 — Weekly Service Post Inclusion</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">1st Slide Position</p>
              <p class="text-zinc-500 text-sm">Elite Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-1st" value="90"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">2nd Slide Position</p>
              <p class="text-zinc-500 text-sm">Prime Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-2nd" value="75"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">3rd Slide Position</p>
              <p class="text-zinc-500 text-sm">Select Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-3rd" value="60"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">4th+ Slide Position</p>
              <p class="text-zinc-500 text-sm">Standard Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-4th" value="50"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg md:col-span-2">
            <div>
              <p class="font-medium">Specific Post</p>
              <p class="text-zinc-500 text-sm">Full Feature - Dedicated post</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-specific" value="150"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

      <!-- Offer 02: Spotify -->
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
        <h3 class="text-zinc-400 text-sm uppercase tracking-wider mb-4">Offer 02 — Spotify Growth Packages</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">10-20k Streams</p>
              <p class="text-zinc-500 text-sm">Starter - Initial Momentum</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-starter" value="590"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">25-45k Streams</p>
              <p class="text-zinc-500 text-sm">Growth - Algorithm Trigger</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-growth" value="990"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">45k+ Streams</p>
              <p class="text-zinc-500 text-sm">Platinum - Full Velocity</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-platinum" value="1590"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- Status -->
    <section class="mt-8 text-center text-zinc-600 text-sm">
      <p id="status">Les modifications seront en ligne ~10 secondes après sauvegarde</p>
    </section>

    <!-- Gallery Section -->
    <section class="mt-12 pt-8 border-t border-zinc-800">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-lg font-medium">Galerie de pages</h2>
          <p class="text-zinc-500 text-sm">Ajoutez et gérez vos pages HTML</p>
        </div>
        <label class="bg-white text-black px-4 py-2 rounded-lg font-medium cursor-pointer hover:bg-zinc-200 transition">
          + Ajouter HTML
          <input type="file" id="gallery-file-input" accept=".html,.htm" class="hidden">
        </label>
      </div>

      <!-- Pages Grid -->
      <div id="pages-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Pages will be inserted here -->
      </div>
    </section>

  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const PUBLIC_URL = 'https://discovery-service.vercel.app';

    // Font options
    const FONTS = {
      outfit: '"Outfit", sans-serif',
      system: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
    };
    let selectedFont = 'outfit';

    function selectFont(font) {
      selectedFont = font;
      // Update UI
      document.getElementById('font-outfit').classList.toggle('border-blue-500', font === 'outfit');
      document.getElementById('font-outfit').classList.toggle('border-zinc-700', font !== 'outfit');
      document.getElementById('font-system').classList.toggle('border-blue-500', font === 'system');
      document.getElementById('font-system').classList.toggle('border-zinc-700', font !== 'system');
    }

    function detectCurrentFont(html) {
      if (html.includes('font-family: -apple-system') || html.includes('font-family: "Segoe UI"')) {
        return 'system';
      }
      return 'outfit';
    }

    // Price mapping to HTML content
    const priceMap = {
      'price-1st': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€90<\/span>/, label: '€90' },
      'price-2nd': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€75<\/span>/, label: '€75' },
      'price-3rd': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€60<\/span>/, label: '€60' },
      'price-4th': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€50<\/span>/, label: '€50' },
      'price-specific': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€150<\/span>/, label: '€150' },
      'price-spotify-starter': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€590<\/span>/, label: '€590' },
      'price-spotify-growth': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€990<\/span>/, label: '€990' },
      'price-spotify-platinum': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€1,590<\/span>/, label: '€1,590' },
    };

    let originalHtml = '';

    // Load current HTML on page load
    async function loadCurrentHtml() {
      try {
        const res = await fetch('/index.html');
        originalHtml = await res.text();

        // Extract current prices and update inputs
        extractPrices(originalHtml);

        // Detect current font and update selector
        selectedFont = detectCurrentFont(originalHtml);
        selectFont(selectedFont);
      } catch (e) {
        console.error('Failed to load HTML:', e);
      }
    }

    function extractPrices(html) {
      // Extract prices using regex
      const patterns = [
        { id: 'price-1st', regex: /Elite Spot[\s\S]*?€(\d+)/ },
        { id: 'price-2nd', regex: /Prime Spot[\s\S]*?€(\d+)/ },
        { id: 'price-3rd', regex: /Select Spot[\s\S]*?€(\d+)/ },
        { id: 'price-4th', regex: /Standard Spot[\s\S]*?€(\d+)/ },
        { id: 'price-specific', regex: /Full Feature[\s\S]*?€(\d+)/ },
        { id: 'price-spotify-starter', regex: /INITIAL[\s\S]*?MOMENTUM[\s\S]*?€([\d,]+)/ },
        { id: 'price-spotify-growth', regex: /ALGORITHM[\s\S]*?TRIGGER[\s\S]*?€([\d,]+)/ },
        { id: 'price-spotify-platinum', regex: /FULL[\s\S]*?VELOCITY[\s\S]*?€([\d,]+)/ },
      ];

      patterns.forEach(({ id, regex }) => {
        const match = html.match(regex);
        if (match) {
          const value = match[1].replace(',', '');
          document.getElementById(id).value = value;
        }
      });
    }

    function formatPrice(value) {
      const num = parseInt(value);
      if (num >= 1000) {
        return num.toLocaleString('en-US').replace(',', ',');
      }
      return num.toString();
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function copyLink() {
      navigator.clipboard.writeText(PUBLIC_URL);
      showToast('Lien copié !');
    }

    async function savePrices() {
      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.innerHTML = '<span>Sauvegarde...</span>';
      showToast('Mise à jour en cours...', 'loading');

      try {
        // Get new prices
        const prices = {
          '1st': document.getElementById('price-1st').value,
          '2nd': document.getElementById('price-2nd').value,
          '3rd': document.getElementById('price-3rd').value,
          '4th': document.getElementById('price-4th').value,
          'specific': document.getElementById('price-specific').value,
          'spotify-starter': document.getElementById('price-spotify-starter').value,
          'spotify-growth': document.getElementById('price-spotify-growth').value,
          'spotify-platinum': document.getElementById('price-spotify-platinum').value,
        };

        // Update HTML with new prices
        let newHtml = originalHtml;

        // Update font (body only, not title-font)
        newHtml = newHtml.replace(
          /body\s*\{[\s\S]*?font-family:[^;]+;/,
          `body {\n        font-family: ${FONTS[selectedFont]};`
        );

        // Offer 01 prices (text-4xl)
        newHtml = newHtml.replace(
          /(Elite Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['1st']}$2`
        );
        newHtml = newHtml.replace(
          /(Prime Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['2nd']}$2`
        );
        newHtml = newHtml.replace(
          /(Select Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['3rd']}$2`
        );
        newHtml = newHtml.replace(
          /(Standard Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['4th']}$2`
        );
        newHtml = newHtml.replace(
          /(Full Feature[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['specific']}$2`
        );

        // Offer 02 prices (text-5xl) - with comma formatting for 1000+
        newHtml = newHtml.replace(
          /(INITIAL[\s\S]*?MOMENTUM[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-starter'])}$2`
        );
        newHtml = newHtml.replace(
          /(ALGORITHM[\s\S]*?TRIGGER[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-growth'])}$2`
        );
        newHtml = newHtml.replace(
          /(FULL[\s\S]*?VELOCITY[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-platinum'])}$2`
        );

        // Send to API
        const res = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: newHtml,
            filename: 'index.html',
            message: `Update: font=${selectedFont}, prices: 1st=${prices['1st']}, 2nd=${prices['2nd']}, 3rd=${prices['3rd']}, 4th=${prices['4th']}, specific=${prices['specific']}, spotify=${prices['spotify-starter']}/${prices['spotify-growth']}/${prices['spotify-platinum']}`
          })
        });

        const data = await res.json();

        if (data.success) {
          originalHtml = newHtml;
          showToast('Prix mis à jour ! En ligne dans ~10s', 'success');
          document.getElementById('status').textContent = 'Dernière mise à jour : ' + new Date().toLocaleTimeString('fr-FR');
        } else {
          throw new Error(data.error || 'Update failed');
        }
      } catch (e) {
        showToast('Erreur: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Sauvegarder</span>';
      }
    }

    // ========== GALLERY ==========
    const GALLERY_STORAGE_KEY = 'discovery-gallery-pages';
    let galleryPages = JSON.parse(localStorage.getItem(GALLERY_STORAGE_KEY) || '[]');

    // Initialize with index.html if empty
    if (galleryPages.length === 0) {
      galleryPages = [
        { name: 'Discovery Service', filename: 'index.html', isMain: true }
      ];
      localStorage.setItem(GALLERY_STORAGE_KEY, JSON.stringify(galleryPages));
    }

    function renderGallery() {
      const grid = document.getElementById('pages-grid');

      grid.innerHTML = galleryPages.map((page, index) => `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden group">
          <div class="h-32 bg-white relative">
            <iframe src="/${page.filename}"
                    class="w-[400%] h-[400%] origin-top-left scale-[0.25] pointer-events-none"></iframe>
          </div>
          <div class="p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <p class="font-medium truncate">${page.name}</p>
                <p class="text-zinc-500 text-xs">${page.filename}</p>
              </div>
              ${page.isMain ? '<span class="text-xs bg-blue-600 px-2 py-1 rounded">Principal</span>' : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="copyPageLink('${page.filename}')"
                      class="flex-1 px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm transition">
                Copier le lien
              </button>
              <a href="/${page.filename}" target="_blank"
                 class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
              ${!page.isMain ? `
              <button onclick="deletePage(${index})"
                      class="px-3 py-2 bg-zinc-800 hover:bg-red-600 rounded-lg text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function copyPageLink(filename) {
      const url = `${PUBLIC_URL}/${filename === 'index.html' ? '' : filename}`;
      navigator.clipboard.writeText(url);
      showToast('Lien copié !');
    }

    async function uploadPage(file) {
      const filename = file.name.toLowerCase().replace(/\s+/g, '-');
      const reader = new FileReader();

      reader.onload = async (e) => {
        const content = e.target.result;
        showToast('Upload en cours...', 'loading');

        try {
          const res = await fetch('/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              content: content,
              filename: filename,
              message: `Add page: ${filename}`
            })
          });

          const data = await res.json();

          if (data.success) {
            // Add to gallery
            galleryPages.push({
              name: file.name.replace('.html', '').replace('.htm', ''),
              filename: filename,
              isMain: false
            });
            localStorage.setItem(GALLERY_STORAGE_KEY, JSON.stringify(galleryPages));
            renderGallery();
            showToast('Page ajoutée ! En ligne dans ~10s', 'success');
          } else {
            throw new Error(data.error);
          }
        } catch (e) {
          showToast('Erreur: ' + e.message, 'error');
        }
      };

      reader.readAsText(file);
    }

    async function deletePage(index) {
      const page = galleryPages[index];
      if (page.isMain) return;

      if (!confirm(`Supprimer "${page.name}" ?`)) return;

      // Note: On ne supprime pas le fichier sur GitHub, juste de la galerie locale
      // Pour une vraie suppression, il faudrait une API delete
      galleryPages.splice(index, 1);
      localStorage.setItem(GALLERY_STORAGE_KEY, JSON.stringify(galleryPages));
      renderGallery();
      showToast('Page retirée de la galerie');
    }

    // File input handler
    document.getElementById('gallery-file-input').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        uploadPage(e.target.files[0]);
        e.target.value = '';
      }
    });

    // Init
    loadCurrentHtml();
    renderGallery();
  </script>
</body>
</html>
