<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discovery Service - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .toast {
      position: fixed; bottom: 24px; right: 24px;
      padding: 12px 20px; border-radius: 8px; font-weight: 500;
      opacity: 0; transform: translateY(10px); transition: all 0.3s;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #10b981; color: white; }
    .toast.error { background: #ef4444; color: white; }
    .toast.loading { background: #3b82f6; color: white; }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="min-h-screen bg-zinc-950 text-white">

  <!-- Header -->
  <header class="border-b border-zinc-800 px-6 py-4">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Discovery Service</h1>
        <p class="text-zinc-500 text-sm">Admin - Gestion des prix</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/" target="_blank" class="text-zinc-400 hover:text-white text-sm transition">
          Voir le site →
        </a>
        <button onclick="copyLink()" class="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition">
          Copier le lien
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-6">

    <!-- Link Section -->
    <section class="mb-8 p-4 bg-zinc-900 border border-zinc-800 rounded-xl">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-zinc-500 text-sm mb-1">Lien public à partager</p>
          <p class="text-lg font-medium" id="public-link">https://discovery-service.vercel.app</p>
        </div>
        <button onclick="copyLink()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-medium transition">
          Copier
        </button>
      </div>
    </section>

    <!-- Pricing Editor -->
    <section class="space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium">Modifier les prix</h2>
        <button onclick="savePrices()" id="save-btn"
                class="bg-green-600 hover:bg-green-500 px-5 py-2 rounded-lg font-medium transition flex items-center gap-2">
          <span>Sauvegarder</span>
        </button>
      </div>

      <!-- Offer 01: Weekly Service -->
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
        <h3 class="text-zinc-400 text-sm uppercase tracking-wider mb-4">Offer 01 — Weekly Service Post Inclusion</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">1st Slide Position</p>
              <p class="text-zinc-500 text-sm">Elite Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-1st" value="90"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">2nd Slide Position</p>
              <p class="text-zinc-500 text-sm">Prime Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-2nd" value="75"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">3rd Slide Position</p>
              <p class="text-zinc-500 text-sm">Select Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-3rd" value="60"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div>
              <p class="font-medium">4th+ Slide Position</p>
              <p class="text-zinc-500 text-sm">Standard Spot</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-4th" value="50"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex items-center justify-between p-4 bg-zinc-800/50 rounded-lg md:col-span-2">
            <div>
              <p class="font-medium">Specific Post</p>
              <p class="text-zinc-500 text-sm">Full Feature - Dedicated post</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-specific" value="150"
                     class="w-20 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

      <!-- Offer 02: Spotify -->
      <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
        <h3 class="text-zinc-400 text-sm uppercase tracking-wider mb-4">Offer 02 — Spotify Growth Packages</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">10-20k Streams</p>
              <p class="text-zinc-500 text-sm">Starter - Initial Momentum</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-starter" value="590"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">25-45k Streams</p>
              <p class="text-zinc-500 text-sm">Growth - Algorithm Trigger</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-growth" value="990"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
          <div class="flex flex-col justify-between p-4 bg-zinc-800/50 rounded-lg">
            <div class="mb-3">
              <p class="font-medium">45k+ Streams</p>
              <p class="text-zinc-500 text-sm">Platinum - Full Velocity</p>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-zinc-500">€</span>
              <input type="number" id="price-spotify-platinum" value="1590"
                     class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-right text-lg font-semibold focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

    </section>

    <!-- Status -->
    <section class="mt-8 text-center text-zinc-600 text-sm">
      <p id="status">Les modifications seront en ligne ~10 secondes après sauvegarde</p>
    </section>

  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const PUBLIC_URL = 'https://discovery-service.vercel.app';

    // Price mapping to HTML content
    const priceMap = {
      'price-1st': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€90<\/span>/, label: '€90' },
      'price-2nd': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€75<\/span>/, label: '€75' },
      'price-3rd': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€60<\/span>/, label: '€60' },
      'price-4th': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€50<\/span>/, label: '€50' },
      'price-specific': { search: /<span class="text-4xl font-semibold tracking-tight leading-none">€150<\/span>/, label: '€150' },
      'price-spotify-starter': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€590<\/span>/, label: '€590' },
      'price-spotify-growth': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€990<\/span>/, label: '€990' },
      'price-spotify-platinum': { search: /<span class="text-5xl font-semibold tracking-tighter leading-none">€1,590<\/span>/, label: '€1,590' },
    };

    let originalHtml = '';

    // Load current HTML on page load
    async function loadCurrentHtml() {
      try {
        const res = await fetch('/index.html');
        originalHtml = await res.text();

        // Extract current prices and update inputs
        extractPrices(originalHtml);
      } catch (e) {
        console.error('Failed to load HTML:', e);
      }
    }

    function extractPrices(html) {
      // Extract prices using regex
      const patterns = [
        { id: 'price-1st', regex: /Elite Spot[\s\S]*?€(\d+)/ },
        { id: 'price-2nd', regex: /Prime Spot[\s\S]*?€(\d+)/ },
        { id: 'price-3rd', regex: /Select Spot[\s\S]*?€(\d+)/ },
        { id: 'price-4th', regex: /Standard Spot[\s\S]*?€(\d+)/ },
        { id: 'price-specific', regex: /Full Feature[\s\S]*?€(\d+)/ },
        { id: 'price-spotify-starter', regex: /INITIAL[\s\S]*?MOMENTUM[\s\S]*?€([\d,]+)/ },
        { id: 'price-spotify-growth', regex: /ALGORITHM[\s\S]*?TRIGGER[\s\S]*?€([\d,]+)/ },
        { id: 'price-spotify-platinum', regex: /FULL[\s\S]*?VELOCITY[\s\S]*?€([\d,]+)/ },
      ];

      patterns.forEach(({ id, regex }) => {
        const match = html.match(regex);
        if (match) {
          const value = match[1].replace(',', '');
          document.getElementById(id).value = value;
        }
      });
    }

    function formatPrice(value) {
      const num = parseInt(value);
      if (num >= 1000) {
        return num.toLocaleString('en-US').replace(',', ',');
      }
      return num.toString();
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function copyLink() {
      navigator.clipboard.writeText(PUBLIC_URL);
      showToast('Lien copié !');
    }

    async function savePrices() {
      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.innerHTML = '<span>Sauvegarde...</span>';
      showToast('Mise à jour en cours...', 'loading');

      try {
        // Get new prices
        const prices = {
          '1st': document.getElementById('price-1st').value,
          '2nd': document.getElementById('price-2nd').value,
          '3rd': document.getElementById('price-3rd').value,
          '4th': document.getElementById('price-4th').value,
          'specific': document.getElementById('price-specific').value,
          'spotify-starter': document.getElementById('price-spotify-starter').value,
          'spotify-growth': document.getElementById('price-spotify-growth').value,
          'spotify-platinum': document.getElementById('price-spotify-platinum').value,
        };

        // Update HTML with new prices
        let newHtml = originalHtml;

        // Offer 01 prices (text-4xl)
        newHtml = newHtml.replace(
          /(Elite Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['1st']}$2`
        );
        newHtml = newHtml.replace(
          /(Prime Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['2nd']}$2`
        );
        newHtml = newHtml.replace(
          /(Select Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['3rd']}$2`
        );
        newHtml = newHtml.replace(
          /(Standard Spot[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['4th']}$2`
        );
        newHtml = newHtml.replace(
          /(Full Feature[\s\S]*?<span class="text-4xl font-semibold tracking-tight leading-none">)€\d+([\s\S]*?<\/span>)/,
          `$1€${prices['specific']}$2`
        );

        // Offer 02 prices (text-5xl) - with comma formatting for 1000+
        newHtml = newHtml.replace(
          /(INITIAL[\s\S]*?MOMENTUM[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-starter'])}$2`
        );
        newHtml = newHtml.replace(
          /(ALGORITHM[\s\S]*?TRIGGER[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-growth'])}$2`
        );
        newHtml = newHtml.replace(
          /(FULL[\s\S]*?VELOCITY[\s\S]*?<span class="text-5xl font-semibold tracking-tighter leading-none">)€[\d,]+([\s\S]*?<\/span>)/,
          `$1€${formatPrice(prices['spotify-platinum'])}$2`
        );

        // Send to API
        const res = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: newHtml,
            filename: 'index.html',
            message: `Update prices: 1st=${prices['1st']}, 2nd=${prices['2nd']}, 3rd=${prices['3rd']}, 4th=${prices['4th']}, specific=${prices['specific']}, spotify=${prices['spotify-starter']}/${prices['spotify-growth']}/${prices['spotify-platinum']}`
          })
        });

        const data = await res.json();

        if (data.success) {
          originalHtml = newHtml;
          showToast('Prix mis à jour ! En ligne dans ~10s', 'success');
          document.getElementById('status').textContent = 'Dernière mise à jour : ' + new Date().toLocaleTimeString('fr-FR');
        } else {
          throw new Error(data.error || 'Update failed');
        }
      } catch (e) {
        showToast('Erreur: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>Sauvegarder</span>';
      }
    }

    // Init
    loadCurrentHtml();
  </script>
</body>
</html>
